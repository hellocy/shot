<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <style>
        *{
            padding:0;
            margin:0;
        }
        html, body{
            overflow: hidden;
        }

        #-box{
            position: absolute;
            left:0;
            top: 0;
        }

        #score-box{
            position: absolute;
            bottom:5px;
            left: 5px;
            z-index: 999;
        }

        #gun{
            position:absolute;
            width: 30px;
            height: 20px;
            left: 50px;
            bottom: 50px;
            background:#0B7500;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        #gun:before{
            content: '';
            position: absolute;
            left: 13px;
            top: -5px;
            width: 5px;
            height: 5px;
            background: #0B7500;
        }
        .bullet{
            position:absolute;
            width: 4px;
            height: 14px;
            background:saddlebrown;
            border-radius: 50%;
        }
        .bubble{
            position: absolute;
            display:inline-block;
            border-radius: 50%;
        }
        .explode{
            animation: mymove 5s;
            -webkit-animation: mymove 5s; /*Safari and Chrome*/
        }

        @keyframes mymove{
            from {
                left:0px;
            }
            to {left:200px;}
        }

        @-webkit-keyframes mymove{
            from {left:0px;}
            to {left:200px;}
        }
        #toolbar{
            width: 30px;
            position: absolute;
            top: 100px;
            right: 0;
            height:40px;
            text-align: center;
        }
        #toolbar button{
            width: 30px;
            height:50px;
            margin-top:20px;
            text-align:center;
        }

        .score-line{
            position: absolute;
            left: 0px;
            bottom: 49px;
            width: 100%;
            height: 1px;
            background: #0B7500;
        }

        @keyframes explode {
            from {
                transform: scale(1);
                opacity: 1;
            }
            to {
                transform: scale(2);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
<p id="score-box">score：<span id="score">0</span></p>
<div id="gun"></div>
<div class="score-line"></div>
<div id="toolbar">
    <button type="button" id="btn-begin">开始</button>
    <button type="button" id="btn-pause">暂停</button>
    <button type="button" id="btn-restart">重开</button>
</div>
</body>
<script>

    // 构造子弹
    const Bullet = function () {
        this.timer = null;
        this.el = null;
        this.run = function (watcher, allBubbles) {
            let that = this;

            cancelAnimationFrame(this.timer);
            this.timer = requestAnimationFrame(function init(){
                let rect = that.el.getBoundingClientRect();
                let cx = rect.x;
                let cr = rect.right;
                let cb = rect.bottom;
                let dy = rect.top;
                if(dy == 0){
                    that.el.parentNode && that.el.parentNode.removeChild(that.el);
                    return;
                }
                let cy = dy + watcher.bulletSpeed;
                that.el.style.top = cy + 'px';

                let bulletIdx = watcher.bullets.indexOf(that);

                for(let i = 0, len = allBubbles.all.length; i < len; i++) {
                    let bubblei = allBubbles.all[i];
                    let _rect = bubblei.el.getBoundingClientRect();

                    if (cy <= _rect.bottom && cx > _rect.x - 5 && cr < _rect.right + 5) {

                        cancelAnimationFrame(bubblei.timer);
                        bubblei.el.style.animation = 'explode 0.3s';
                        allBubbles.all.splice(i, 1);
                        watcher.record(bubblei);
                        watcher.update();
                        that.el.parentNode && that.el.parentNode.removeChild(that.el);
                        watcher.bullets.splice(bulletIdx, 1);
                        cancelAnimationFrame(that.timer);
                        break;
                    }
                }

                if (cb < -14) {
                    that.el.parentNode.removeChild(that.el);
                    watcher.bullets.splice(bulletIdx, 1);
                    cancelAnimationFrame(that.timer);
                } else {
                    that.timer = requestAnimationFrame(init);
                }

            });
        }
    }

    Bullet.prototype.init = function (){
        let _gunRect = gun.getBoundingClientRect();
        this.el = document.createElement('span');
        this.el.className = 'bullet';
        let _x = (_gunRect.x || _gunRect.left) + _gunRect.width / 2 - 2;
        let _y = _gunRect.top - 14;
        this.el.style.left = _x + 'px'
        this.el.style.top = _y + 'px'
        document.body.appendChild(this.el);
        return this;
    }

    // 构造气泡
    const Bubble = function () {
        this.timer = null;
        this.el = null;
        this.r = 0;

        this.bg = function () {
            let r = randomFrom(0, 255);
            let g = randomFrom(0, 255);
            let b = randomFrom(0, 255);
            return 'rgb('+r+', '+g+', '+b+')';
        }

        this.create = function (x, y, r) {
            let el = document.createElement('span');
            this.r = r;
            el.className = 'bubble';
            el.style.left = x + 'px'
            el.style.top = y + 'px'
            el.style.width = r + 'px';
            el.style.height = r + 'px';
            el.style.backgroundColor = this.bg();
            this.el = el;
            document.body.appendChild(this.el);
            this.el.addEventListener("webkitAnimationEnd",function(){
                document.body.removeChild(el);
            });
            return this;
        }
    }

    Bubble.prototype.run = function (speed, watcher) {
        let that = this;
        var speed = speed || 0.1;
        var winH = window.innerHeight;
        this.timer = requestAnimationFrame(function go() {
            let rect = that.el.getBoundingClientRect();
            let cy = rect.top + speed;
            let cb = rect.bottom;
            that.el.style.top = cy + 'px';
            if(cy > winH) {
                that.el.parentNode.removeChild(that.el);
                cancelAnimationFrame(that.timer);
            }else if (cb > watcher.gunTop - 5) {
                watcher.stop();
            }else{
                that.timer = requestAnimationFrame(go);
            }
        })
    }

    Bubble.prototype.exploded = function () {
        this.el.parentNode.removeChild(this.el);
    }

    const BubbleFactory = function () {
        this.speed = 1;
        this.all = [];
        this.timer;
    }

    BubbleFactory.prototype.create = function (watcher) {
        let that = this;
        let winW = window.innerWidth;
        for(let i = 0; i < 2; i++){
            let r = randomFrom(10, 35);
            let _x = randomFrom(0, winW - r);
            let _y = -r;

            let bubble = new Bubble();
            that.all.push(bubble);
            bubble.create(_x, _y, r);
            bubble.run(that.speed, watcher);
        }
    }

    // 观察者 （当子弹击中气泡，气泡就爆炸，得分，有气泡触底，则游戏结束）
    let Watcher = function () {
        this.score = 0;
        this.bulletSpeed = -5; // 子弹射击速度
        this.bulletFre = 300 // 子弹发射频率
        this.bubbleSpeed = 1; // 气泡下移速度
        this.bulletTimer = null;
        this.bullets = [];
        this.bubbleFty = null;
        this.$gun = document.querySelector("#gun");
        this.gunTop = 0;
        this.$scorer = document.querySelector("#score");

        this.init = function () {
            let that = this;
            let gunRect = this.$gun.getBoundingClientRect();
            this.gunTop = gunRect.top
            let hMax = window.innerWidth;
            let initLeft = (hMax - gunRect.width ) / 2;

            this.$gun.style.left = initLeft + 'px';

            let btnStart = document.querySelector('#btn-begin');
            let btnPause = document.querySelector('#btn-pause');
            let btnRestart = document.querySelector('#btn-restart');

            // 开始
            btnStart.addEventListener('click', function(e){
                that.begin();
            })

            // 暂停
            btnPause.addEventListener('click', function(e){
                cancelAnimationFrame(timer);
            })

            // 重开
            btnRestart.addEventListener('click', function(e){
                that.restart();
            })

            that.$gun.ontouchstart = function (e) {
                var that = this;
                var ix = e.touches[0].clientX;
                console.log(ix)
                var ox = this.getBoundingClientRect().x;
                document.ontouchmove = function (e) {
                    var cx = e.touches[0].clientX;
                    var dx = cx - ix;
                    that.style.left = (ox + dx) + 'px';

                    document.ontouchend = function (e) {
                        document.onmousemove = null
                        document.onmouseup = null
                    }
                }
            }

            // 监听手机Y轴方向的转动，水平移动手杆 #gun
            window.addEventListener('deviceorientation',function (e) {
                let cx = initLeft + e.gamma * 10;
                that.$gun.style.left = Math.max(-10, Math.min(cx, hMax - 30 + 10)) + 'px';
            })
        }

        // 开始游戏
        this.begin = function () {
            let that = this;
            navigator.vibrate([100]);

            this.bubbleFty = new BubbleFactory();

            this.bubbleFty.create(that);

            this.bubbleFty.timer = setInterval(function() {
                that.bubbleFty.create(that);
            }, 1000);

            // 发射子弹
            this.bulletTimer = setInterval(function(){
                let bullet = new Bullet();
                that.bullets.push(bullet);
                bullet.init();
                bullet.run(that, that.bubbleFty);
            }, that.bulletFre)
        }

        this.stop = function () {
            let bullets = this.bullets;
            let bubbles = this.bubbleFty.all;
            clearInterval(this.bubbleFty.timer);
            clearInterval(this.bulletTimer);
            for (let i = 0, len = bubbles.length; i < len; i++) {
                cancelAnimationFrame(bubbles[i].timer);
            }
            for (let i = 0, len = bullets.length; i < len; i++) {
                cancelAnimationFrame(bullets[i].timer);
            }
        }

        this.record = function (bubble) {
            this.score += bubble.r;
            this.$scorer.innerText = this.score;
        }

        this.update = function () {
            var newSpeed = this.score / 500;
            this.bubbleFty.speed = newSpeed < 1 ? 1 : newSpeed;
            this.bulletFre = Math.round(300 - this.bubbleFty.speed * 50)
        }

        this.restart = function () {
            this.score = 0;
            this.bulletSpeed = -5; // 子弹射击速度
            this.bulletFre = 300 // 子弹发射频率
            this.bubbleSpeed = 1; // 气泡下移速度

            for(let i = 0, len = this.bubbleFty.all.length; i < len; i++){
                cancelAnimationFrame(this.bubbleFty.all[i].timer);
                document.body.removeChild(this.bubbleFty.all[i].el);
            }
            for(let i = 0, len = this.bullets.length; i < len; i++){
                cancelAnimationFrame(this.bullets[i].timer);
                document.body.removeChild(this.bullets[i].el);
            }
            clearInterval(this.bubbleFty.timer);
            clearInterval(this.bulletTimer);

            this.bubbleFty = null;
            this.bullets = [];
        }
    }

    let watcher = new Watcher();
    watcher.init();


    function randomFrom(lowerValue,upperValue){
        return Math.floor(Math.random() * (upperValue - lowerValue + 1) + lowerValue);
    }

    // 快速排序
    function quickSort(arr){
        if (arr.length <= 1) {return arr;}
        let pivotIndex = Math.floor(arr.length / 2);
        let pivot = arr.splice(pivotIndex, 1)[0];
        let pivotRect = pivot.el.getBoundingClientRect();
        let left = [];
        let right = [];
        for (let i = 0; i < arr.length; i++) {
            let recti = arr[i].el.getBoundingClientRect();
            if(recti.x <= pivotRect.x){
                left.push(arr[i]);
            }
            else{
                right.push(arr[i]);
            }
        }
        return quickSort(left).concat([pivot], quickSort(right));
    }

    function hasClass(ele, cls) {
        cls = cls || '';
        if (cls.replace(/\s/g, '').length == 0) return false; //当cls没有参数时，返回false
        return new RegExp(' ' + cls + ' ').test(' ' + ele.className + ' ');
    }

    function addClass(ele, cls) {
        if (!hasClass(ele, cls)) {
            ele.className = ele.className == '' ? cls : ele.className + ' ' + cls;
        }
    }

    function removeClass(ele, cls) {
        if (hasClass(ele, cls)) {
            var newClass = ' ' + ele.className.replace(/[\t\r\n]/g, '') + ' ';
            while (newClass.indexOf(' ' + cls + ' ') >= 0) {
                newClass = newClass.replace(' ' + cls + ' ', ' ');
            }
            ele.className = newClass.replace(/^\s+|\s+$/g, '');
        }
    }
</script>
</html>
